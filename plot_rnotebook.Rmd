---
title: "tidyverse RNotebook"
output:
  html_document: default
  html_notebook: default
---

## rwars

```{r, rwars_intro}

library(rwars)
films <- get_all_films()$results

```

## tidyverse

The tidyverse is a collection of R packages that share common philosophies and are designed to work together. This site is a work-in-progress guide to the tidyverse and its packages.

```{r, tidvyverse_intro}

library(tidyverse)

```
 
 
 
 
## purrr 
 
*purrr* enhances R’s functional programming (FP) toolkit by providing a complete and consistent set of tools for working with functions and vectors. If you’ve never heard of FP before, the best place to start is the family of map() functions which allow you to replace many for loops with code that is both more succinct and easier to read. The best place to learn about the map() functions is the iteration chapter in R for data science.

Using `sapply`

```{r}
lapply(films, function(x)x$title)
```

```{r}
map(films, "title")
```

```{r}
map_chr(films, "title")
```

## tibble

A *tibble*, or *tbl_df*, is a modern reimagining of the data.frame, keeping what time has proven to be effective, and throwing out what is not. Tibbles are data.frames that are *lazy and surly*: they do less (i.e. they don’t change variable names or types, and don’t do partial matching) and complain more (e.g. when a variable does not exist). This forces you to confront problems earlier, typically leading to cleaner, more expressive code. Tibbles also have an enhanced print method() which makes them easier to use with large datasets containing complex objects.  

*Edgar's note* - No more `stringsAsFactors = FALSE` ! 


```{r}
data.frame(
  a = c(1:10),
  b = c("a","a","a","a","a","a","a","a","a","a"))
```


```{r}
tibble(
  a = c(1:10),
  b = c("a","a","a","a","a","a","a","a","a","a"))
```

## Packages assemble!

```{r}
results <- tibble(
  title = map_chr(films, "title"),
  episode = map_dbl(films, "episode_id"),
  starships = map_dbl(films, ~length(.x$starships)),
  vehicles = map_dbl(films, ~length(.x$vehicles)),
  planets = map_dbl(films, ~length(.x$planets))
) 

results
```


```{r}
trilogies <- c("Prequels: Episode I-III", "Originals: Episode IV-VI", "Sequels: Episode VII")

results <- results %>%
  mutate(ratio = starships / (vehicles + starships) * 100) %>% 
  mutate(Trilogy = trilogies[findInterval(episode, c(1,4,7))])


results
```


### Visualize it

```{r}
p <- ggplot(results, aes(reorder(title, episode), ratio)) + 
  geom_bar(aes(fill = Trilogy), stat = "identity", size = 1)

p
```
```{r}
p <- p +
  labs(
    title = "The Rise of Hyperdrive",
    subtitle = "Percentage of Ships with Hyperdrive Capability"
  )

p
```

```{r}
library(ggthemes)

p <- p +
  scale_y_continuous(labels = function(x){paste(x,"%")}) +
  theme_fivethirtyeight() +
  scale_colour_fivethirtyeight() +
  theme(
    axis.text.x = element_text(angle = 35, vjust = 0.9, hjust = 0.9)
  )

p
```

```{r}

tibble(
  title = map_chr(films, "title"),
  episode = map_dbl(films, "episode_id"),
  starships = map_dbl(films, ~length(.x$starships)),
  vehicles = map_dbl(films, ~length(.x$vehicles)),
  planets = map_dbl(films, ~length(.x$planets))
) %>% 
  mutate(ratio = starships / (vehicles + starships) * 100) %>% 
  mutate(Trilogy = trilogies[findInterval(episode, c(1,4,7))]) %>%
  ggplot(aes(reorder(title, episode), ratio)) + 
    geom_bar(aes(fill = Trilogy), stat = "identity", size = 1) +
    labs(
      title = "The Rise of Hyperdrive",
      subtitle = "Percentage of Ships with Hyperdrive Capability"
    ) +
    scale_y_continuous(labels = function(x){paste(x,"%")}) +
    theme_fivethirtyeight() +
    scale_colour_fivethirtyeight() +
    theme(
      axis.text.x = element_text(angle = 35, vjust = 0.9, hjust = 0.9)
    )
  
```

